// Import upload files module
var fs = require('fs'),
        request = require('request'),
        sizeOf = require('image-size'),
        randomstring = require("randomstring"),
        Url = require('url'),
        Path = require('path');

var relative_path = "uploaded-files/images/";

exports.Uploads = function(req, res) {
    var tmp_path = req.files.inputimage.path;
    var name = req.files.inputimage.name.replace(/[^a-zA-Z0-9\.]/g, '');
    var dimensions = sizeOf(tmp_path);
    // Path to save images
    var target_path = './public/' + relative_path + name;
    // Check if file type is image
    if (req.files.inputimage.type.indexOf('image') == -1) {
        res.send('The file is not an image');
    } else {
        //Move temporal file tmp_path to target_path
        fs.rename(tmp_path, target_path, function(err) {
            if (err) {
                res.send(JSON.parse({error: 'Error on upload file'}));
                throw err;
            }
            ;
            // Remove temporal file
            fs.unlink(tmp_path, function() {
                if (err) {
                    throw err;
                }
                ;
                res.send({name: name, src: relative_path + name, width: dimensions.width, height: dimensions.height});
            });
        });
    }
};

exports.UpImageFromUrl = function(req, res) {
    var name = randomstring.generate({
        length: 22,
        charset: 'alphanumeric'
    });

    var extension = Path.extname(Url.parse(req.body.urlimageinput).pathname);

    if (extension === undefined || extension === null || extension === "") {
        extension = ".jpg";
    }

    name = name + extension;
    var file = request(req.body.urlimageinput).pipe(fs.createWriteStream('./public/uploaded-files/images/' + name));

    file.on('close', function() {
        var dimensions = sizeOf("./public/uploaded-files/images/" + name);
        res.send({name: name, src: relative_path + name, width: dimensions.width, height: dimensions.height});
    });
};


exports.uploadImage = function(req, res) {
    fs.readFile(req.files.inputimage.path, "base64", function(error, file) {
        if (error) {
            res.send(JSON.parse({error: 'Error on upload file'}));
        } else {
            res.send({file: file,type:req.files.inputimage.type});
        }
    });
};

exports.uploadUrlImage = function(req, res) {
    request.get({url:req.body.urlimageinput,encoding: null}, function(error, response, body) {
        if (!error && response.statusCode == 200) {
            var data = new Buffer(body).toString('base64');
            res.send({file: data, type:response.headers["content-type"], url: req.body.urlimageinput});
        }
    });
};